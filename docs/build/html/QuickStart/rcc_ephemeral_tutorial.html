

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Ephemeral RCC Tutorial &mdash; fluid-run v0.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Set Up your Repository" href="../HowTo/setup_your_repo.html" />
    <link rel="prev" title="Fluid Run" href="../index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> fluid-run
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Quick Start</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ephemeral RCC Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">How To</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/setup_your_repo.html">Set Up your Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/customize_cluster.html">Customize the Test Cluster</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Reference/fluid_run_workflow.html">Fluid Run Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/architecture.html">Architecture Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/fluid_run_reference.html">The Fluid Run CI File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/cli.html">Command Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/dataset_schema.html">Benchmark Dataset Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/environment_variables.html">Environment Variables</a></li>
</ul>
<p class="caption"><span class="caption-text">Support</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Support/support.html">Support</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">fluid-run</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Ephemeral RCC Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/QuickStart/rcc_ephemeral_tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ephemeral-rcc-tutorial">
<h1>Ephemeral RCC Tutorial<a class="headerlink" href="#ephemeral-rcc-tutorial" title="Permalink to this headline">¶</a></h1>
<p>Fluid Run can be used to create ephemeral compute resources for testing HPC applications and to record information about the test for later analysis.
This quickstart guide will introduce you to the necessary ingredients for configuring application tests with fluid-run, using an ephemeral Research Computing Cluster (RCC).</p>
<div class="section" id="demo">
<h2>Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h2>
<p>You will start by using the rcc-ephemeral example provided in the fluid-run repository. This example creates a Singularity image with the <cite>cowsay</cite> program installed on it and then runs tests for this image on an ephemeral RCC cluster. You will learn how to set up your Google Cloud project and create the necessary resources to support application testing, benchmarking, and logging.</p>
<div class="section" id="google-cloud-project-setup">
<h3>Google Cloud Project Setup<a class="headerlink" href="#google-cloud-project-setup" title="Permalink to this headline">¶</a></h3>
<p>To complete this tutorial, you will need to have an active project on Google Cloud.
Sign up and create your first project by visiting <a class="reference external" href="https://console.cloud.google.com">https://console.cloud.google.com</a></p>
<p>Once your project is ready, open <a class="reference external" href="https://shell.cloud.google.com/?show=terminal">Cloud Shell</a></p>
<p>You will need to activate the following Google Cloud APIs</p>
<ul class="simple">
<li>Compute Engine</li>
<li>Cloud Build</li>
<li>Big Query</li>
<li>Identity &amp; Access Management (IAM)</li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>gcloud config <span class="nb">set</span> project PROJECT-ID
gcloud services <span class="nb">enable</span> compute.googleapis.com
gcloud services <span class="nb">enable</span> bigquery.googleapis.com
gcloud services <span class="nb">enable</span> iam.googleapis.com
gcloud services <span class="nb">enable</span> cloudbuild.googleapis.com
</pre></div>
</div>
</div>
<div class="section" id="create-a-fluid-run-docker-image">
<h3>Create a fluid-run Docker image<a class="headerlink" href="#create-a-fluid-run-docker-image" title="Permalink to this headline">¶</a></h3>
<p>The fluid-run application is a <a class="reference external" href="https://cloud.google.com/build/docs/cloud-builders">Cloud Build builder</a>. A Cloud builder is a Docker image that provides an environment and entrypoint application for carrying out a step in a Cloud Build pipeline. You can create the fluid-run docker image and store it in your Google Cloud project’s <a class="reference external" href="https://cloud.google.com/container-registry">Container Registry</a>.</p>
<p><a class="reference external" href="https://shell.cloud.google.com/?show=terminal">Open Cloud Shell</a> and clone the fluid-run repository.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/FluidNumerics/fluid-run.git ~/fluid-run
</pre></div>
</div>
<p>Once you’ve cloned the repository, navigate to the root directory of the repo and trigger a build of the docker image.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/fluid-run/
$ gcloud builds submit . --config<span class="o">=</span>ci/cloudbuild.yaml --substitutions<span class="o">=</span><span class="nv">SHORT_SHA</span><span class="o">=</span>latest
</pre></div>
</div>
<p>This will cause Google Cloud build to create the fluid-run docker image <code class="code docutils literal notranslate"><span class="pre">gcr.io/${PROJECT_ID}/fluid-run:latest</span></code> that you can then use in your project’s builds.</p>
</div>
<div class="section" id="create-the-ci-cb-dataset">
<h3>Create the CI/CB Dataset<a class="headerlink" href="#create-the-ci-cb-dataset" title="Permalink to this headline">¶</a></h3>
<p>The CI/CB dataset is a <a class="reference external" href="https://cloud.google.com/bigquery">Big Query</a> dataset that is used to store information about each test run with fluid-run. This includes runtimes for each execution command used to test your application. The fluid-run repository comes with a terraform module that can create this dataset for your project. We’ve also included an example under the <code class="code docutils literal notranslate"><span class="pre">examples/rcc-ephemeral</span></code> directory that you will use for the rest of this tutorial.</p>
<p>Navigate to the <code class="code docutils literal notranslate"><span class="pre">examples/rcc-ephemeral/ci/build_iac</span></code> directory</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/fluid-run/examples/rcc-ephemeral/ci/build_iac
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">ci/build_iac</span></code> subdirectory contains the <a class="reference external" href="https://terraform.io">Terraform</a> infrastructure as code for provisioning a VPC network, firewall rules, service account, and the Big Query dataset that all support using fluid-run. This example Terraform module is a template for creating these resources, and the <code class="code docutils literal notranslate"><span class="pre">fluid.auto.tfvars</span></code> file in this directory is used to concretize certain variables in the template, so that you can deploy the resources in your project.</p>
<p>Open <code class="code docutils literal notranslate"><span class="pre">fluid.auto.tfvars</span></code> in a text editor and set <code class="code docutils literal notranslate"><span class="pre">&lt;project&gt;</span></code> to your Google Cloud Project ID. The command below will quickly do the search and replace for you.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ sed -i <span class="s2">&quot;s/&lt;project&gt;/</span><span class="k">$(</span>gcloud config get-value project<span class="k">)</span><span class="s2">/g&quot;</span> fluid.auto.tfvars
</pre></div>
</div>
<p>Now, you will execute a workflow typical of Terraform deployments to initialize, validate, plan, and deploy. All of the commands are shown below, but you should review the output from each command before executing the next.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ terraform init
$ terraform validate
$ terraform plan
$ terraform apply --auto-approve
</pre></div>
</div>
<p>Once this completes, you’re ready to run a build using fluid-run.</p>
</div>
<div class="section" id="manually-trigger-a-build">
<h3>Manually Trigger a build<a class="headerlink" href="#manually-trigger-a-build" title="Permalink to this headline">¶</a></h3>
<p>Cloud Build pipelines for a repository are specified in a <a class="reference external" href="https://cloud.google.com/build/docs/build-config-file-schema">build configuration file</a> written in YAML syntax. In this example, three build steps are provided that create a Docker image, create a Singularity image, and test the Singularity image on an ephemeral RCC cluster. A singularity image is created since, currently, fluid-run only supports testing of GCE VM images and Singularity images. However, as you can see, Singularity can convert a Docker image to a Singularity image that can be passed to fluid-run.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">steps</span><span class="p">:</span>

<span class="p p-Indicator">-</span> <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Docker Image</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;gcr.io/cloud-builders/docker&#39;</span>
  <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;build&#39;</span><span class="p p-Indicator">,</span>
         <span class="s">&#39;.&#39;</span><span class="p p-Indicator">,</span>
         <span class="s">&#39;-t&#39;</span><span class="p p-Indicator">,</span>
         <span class="s">&#39;gcr.io/${PROJECT_ID}/cowsay:latest&#39;</span>
  <span class="p p-Indicator">]</span>

<span class="p p-Indicator">-</span> <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Singularity Image</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;quay.io/singularity/singularity:v3.7.1&#39;</span>
  <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;build&#39;</span><span class="p p-Indicator">,</span>
         <span class="s">&#39;cowsay.sif&#39;</span><span class="p p-Indicator">,</span>
         <span class="s">&#39;docker-daemon://gcr.io/${PROJECT_ID}/cowsay:latest&#39;</span><span class="p p-Indicator">]</span>

<span class="p p-Indicator">-</span> <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CI/CB</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;gcr.io/research-computing-cloud/fluid-run&#39;</span>
  <span class="nt">args</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--build-id=${BUILD_ID}&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--git-sha=${COMMIT_SHA}&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--surface-nonzero-exit-code&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--artifact-type=singularity&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--singularity-image=cowsay.sif&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--image=${_IMAGE}&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--project=${PROJECT_ID}&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--zone=${_ZONE}&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--cluster-type=rcc-ephemeral&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--rcc-tfvars=ci/fluid.auto.tfvars&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;--save-results&#39;</span>

<span class="nt">timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1800s</span>

<span class="nt">substitutions</span><span class="p">:</span>
  <span class="nt">_ZONE</span><span class="p">:</span> <span class="s">&#39;us-west1-b&#39;</span>
  <span class="nt">_IMAGE</span><span class="p">:</span> <span class="s">&#39;projects/research-computing-cloud/global/images/family/rcc-centos-7-v3&#39;</span>
</pre></div>
</div>
<p>To manually trigger a build, you can use the <code class="code docutils literal notranslate"><span class="pre">gcloud</span> <span class="pre">builds</span> <span class="pre">submit</span></code> command in your cloud shell. Navigate to the <code class="code docutils literal notranslate"><span class="pre">rcc-ephemeral</span></code> example directory, and submit the build</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/fluid-run/examples/rcc-ephemeral/
$ gcloud builds submit . --config<span class="o">=</span>ci/cloudbuild.yaml
</pre></div>
</div>
<p>Note that the cloud build can be run asynchronously by passing the <code class="code docutils literal notranslate"><span class="pre">--async</span></code> flag as well. If you run asynchronously, you can view the status of the build at the <a class="reference external" href="https://console.cloud.google.com/cloud-build/builds">Cloud Build Console</a>.</p>
</div>
<div class="section" id="view-data-in-big-query">
<h3>View Data in Big Query<a class="headerlink" href="#view-data-in-big-query" title="Permalink to this headline">¶</a></h3>
<p>Once the build is complete, the run-time and other data for each execution command is posted to the fluid_cicb dataset in Big Query. In your browser, <a class="reference external" href="https://console.cloud.google.com/bigquery">navigate to Big Query</a>.</p>
<p>In the data explorer panel on the left-hand side, find your Google Cloud project and expand the dropdown menu.</p>
<a class="reference internal image-reference" href="../_images/biq-query-app_runs.png"><img alt="Big Query App Runs data set" src="../_images/biq-query-app_runs.png" style="width: 800px;" /></a>
<p>Find the fluid-cicb dataset and the app_runs table. Once you’ve selected the app_runs table, select preview.</p>
<a class="reference internal image-reference" href="../_images/biq-query-app_runs_preview.png"><img alt="Big Query App Runs data set in preview" src="../_images/biq-query-app_runs_preview.png" style="width: 800px;" /></a>
<p>At this point, you now have a dataset hosted in Google Cloud. The fluid-run build step with Google Cloud Build will allow you to automate testing and benchmarking of your application and will post results to this dataset.</p>
</div>
<div class="section" id="dashboarding-and-other-post-processing">
<h3>Dashboarding and other post-processing<a class="headerlink" href="#dashboarding-and-other-post-processing" title="Permalink to this headline">¶</a></h3>
<p>From here, it is helpful to visualize results. There are a number of solutions available for visualizing data stored in Big Query. Below are a couple dashboard examples using <a class="reference external" href="https://datastudio.google.com">Data Studio</a> with the fluid_cic data set, to give you an idea of where you can take this.</p>
<p><strong>Example Pass-Fail Report</strong></p>
<a class="reference internal image-reference" href="../_images/pass-fail-report-example.png"><img alt="Pass fail report example" src="../_images/pass-fail-report-example.png" style="width: 800px;" /></a>
<p><strong>Example Runtime Report</strong></p>
<a class="reference internal image-reference" href="../_images/pass-fail-report-example.png"><img alt="Pass fail report example" src="../_images/pass-fail-report-example.png" style="width: 800px;" /></a>
<p>In addition to dashboarding, having a dataset that tracks the performance of your application over time and on a variety of hardware can enable you to automatically check for performance regressions or uncovers performance portability issues. You can write application in C#, Go, Java, Node.js, PHP, Python, and Ruby using the <a class="reference external" href="https://cloud.google.com/bigquery/docs/reference/libraries">Big Query API</a> to interact with the dataset to add further post-processing and verification to your builds.</p>
</div>
<div class="section" id="delete-resources">
<h3>Delete Resources<a class="headerlink" href="#delete-resources" title="Permalink to this headline">¶</a></h3>
<p>If you’ve worked through this tutorial on a Google Cloud project where you will continue setting up a CI/CB workflow for your application, you can keep using the resources you’ve created. However, if you need to tear down the resources created during this tutorial, you can use the commands below</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/fluid-run/examples/rcc-ephemeral/ci/build_iac
$ terraform destroy --auto-approve
</pre></div>
</div>
</div>
</div>
<div class="section" id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="../HowTo/setup_your_repo.html"><span class="doc">Set up your Git Repository</span></a></li>
<li><a class="reference internal" href="../HowTo/customize_cluster.html"><span class="doc">Customize the Benchmarking Cluster</span></a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../HowTo/setup_your_repo.html" class="btn btn-neutral float-right" title="Set Up your Repository" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../index.html" class="btn btn-neutral float-left" title="Fluid Run" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Fluid Numerics LLC.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>